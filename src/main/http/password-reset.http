###
# Password Reset API Tests
# =========================
#
# This file contains comprehensive tests for password reset endpoints:
# - POST /auth/password-reset/request - Request password reset email
# - POST /auth/password-reset/reset - Reset password using token
#
# Variables used:
# - {{baseUrl}} - Base API URL from http-client.env.json
# - {{resetToken}} - Password reset token (extracted from email or database)
#
# Expected Status Codes:
# - 200 OK: Successful password reset request/reset
# - 400 BAD_REQUEST: Validation failures, invalid/expired token
# - 403 FORBIDDEN: Token already used
# - 429 TOO_MANY_REQUESTS: Rate limit exceeded (3 requests per hour)
#
# Security Features:
# - Rate limiting: 3 requests per hour per user
# - Token expiration: 1 hour
# - Single-use tokens (marked as used after password reset)
# - Email enumeration protection (same response regardless of user existence)
#
###

### ============================================
### PASSWORD RESET REQUEST TESTS
### ============================================

### 1. Request Password Reset - Success (200 OK)
# Expected Response: Generic success message (doesn't reveal if user exists)
# {
#   "status": "SUCCESS",
#   "message": "If an account exists with this email, a password reset link has been sent.",
#   "timestamp": "2025-11-13T..."
# }
# Email will be sent to user's inbox with reset link
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": "testuser1762522099@example.com"
}

> {%
    client.test("Password reset request should return 200", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });

    client.test("Response should have SUCCESS status", function() {
        client.assert(response.body.status === "SUCCESS", "Status is not SUCCESS");
    });

    client.test("Response should contain generic message", function() {
        client.assert(response.body.message.includes("If an account exists"), "Message doesn't contain expected text");
    });

    client.log("Password reset email sent (if user exists)");
%}

###

### 2. Request Password Reset for Non-existent User - Success (200 OK)
# Security: Same response to prevent email enumeration
# Prevents attackers from discovering valid email addresses
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": "nonexistent{{$timestamp}}@example.com"
}

> {%
    client.test("Non-existent user should also return 200", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });

    client.test("Response should be identical to existing user", function() {
        client.assert(response.body.status === "SUCCESS", "Status is not SUCCESS");
        client.assert(response.body.message.includes("If an account exists"), "Message differs from existing user");
    });

    client.log("Email enumeration protection: Same response for non-existent user");
%}

###

### 3. Request Password Reset with Invalid Email - Failure (400 BAD_REQUEST)
# Validation error for malformed email address
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": "invalid-email"
}

> {%
    client.test("Invalid email should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });

    client.test("Response should have FAIL status", function() {
        client.assert(response.body.status === "FAIL", "Status is not FAIL");
    });

    client.test("Response should contain validation errors", function() {
        client.assert(response.body.data.email !== undefined, "Email validation error not found");
    });
%}

###

### 4. Request Password Reset with Blank Email - Failure (400 BAD_REQUEST)
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": ""
}

> {%
    client.test("Blank email should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });

    client.test("Response should contain email validation error", function() {
        client.assert(response.body.data.email !== undefined, "Email validation error not found");
    });
%}

###

### 5. Request Password Reset with Null Email - Failure (400 BAD_REQUEST)
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": null
}

> {%
    client.test("Null email should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });
%}

###

### 6. Request Password Reset - Rate Limit Test (429 TOO_MANY_REQUESTS)
# Rate limit: 3 requests per hour per user
# This test requires running requests 1, 1, 1, then this one within 1 hour
# Expected: 429 on 4th request
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": "test@example.com"
}

> {%
    client.test("Rate limit should trigger on 4th request", function() {
        if (response.status === 429) {
            client.log("Rate limit triggered correctly (429)");
            client.assert(response.status === 429, "Should return 429");
        } else {
            client.log("Rate limit not yet exceeded (200). Send more requests within 1 hour.");
            client.assert(response.status === 200, "Should return 200 if under limit");
        }
    });

    if (response.status === 429) {
        client.test("Response should indicate rate limit", function() {
            client.assert(response.body.status === "FAIL", "Status is not FAIL");
            client.assert(response.body.message.includes("wait"), "Message should mention waiting");
        });
    }
%}

###

### ============================================
### PASSWORD RESET TESTS
### ============================================

### 7. Reset Password - Success (200 OK)
# IMPORTANT: Replace {{resetToken}} with actual token from email or database
# Expected Response:
# {
#   "status": "SUCCESS",
#   "message": "Your password has been successfully reset.",
#   "timestamp": "2025-11-13T..."
# }
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "NewSecure123!"
}

> {%
    client.test("Password reset should return 200", function() {
        if (response.status === 400 && response.body.message.includes("Invalid")) {
            client.log("Token is invalid or expired. Get a fresh token from email/database.");
            return;
        }
        client.assert(response.status === 200, "Response status is not 200");
    });

    if (response.status === 200) {
        client.test("Response should have SUCCESS status", function() {
            client.assert(response.body.status === "SUCCESS", "Status is not SUCCESS");
        });

        client.test("Response should contain success message", function() {
            client.assert(response.body.message.includes("successfully reset"), "Message doesn't contain expected text");
        });

        client.log("Password reset successful. User can now login with new password.");
    }
%}

###

### 8. Reset Password with Invalid Token - Failure (400 BAD_REQUEST)
# Expected: PasswordResetTokenInvalidException
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "00000000-0000-0000-0000-000000000000",
  "newPassword": "NewSecure123!"
}

> {%
    client.test("Invalid token should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });

    client.test("Response should have FAIL status", function() {
        client.assert(response.body.status === "FAIL", "Status is not FAIL");
    });

    client.test("Response should indicate invalid token", function() {
        client.assert(response.body.message.includes("Invalid"), "Message doesn't mention invalid token");
    });
%}

###

### 9. Reset Password with Expired Token - Failure (400 BAD_REQUEST)
# Tokens expire after 1 hour
# Expected: PasswordResetTokenExpiredException
# Note: To test this, use a token that was created more than 1 hour ago
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "expired-token-here",
  "newPassword": "NewSecure123!"
}

> {%
    client.test("Expired token should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });

    client.test("Response should indicate token expired", function() {
        if (response.body.message.includes("expired")) {
            client.log("Token expired as expected");
        } else if (response.body.message.includes("Invalid")) {
            client.log("Token not found (either invalid or already used)");
        }
    });
%}

###

### 10. Reset Password with Already Used Token - Failure (403 FORBIDDEN)
# Single-use tokens: Once used, cannot be used again
# Expected: PasswordResetTokenAlreadyUsedException
# Note: Use the same token from test #7 to trigger this
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "AnotherPassword123!"
}

> {%
    client.test("Already used token should return 403", function() {
        if (response.status === 403) {
            client.log("Token already used (correct behavior)");
            client.assert(response.status === 403, "Should return 403");
        } else if (response.status === 400) {
            client.log("Token might be invalid or expired instead of used");
        } else {
            client.log("Unexpected status: " + response.status);
        }
    });

    if (response.status === 403) {
        client.test("Response should indicate token already used", function() {
            client.assert(response.body.message.includes("already been used"), "Message doesn't mention token reuse");
        });
    }
%}

###

### 11. Reset Password with Weak Password - Failure (400 BAD_REQUEST)
# Password must be 8-100 chars with: lowercase, uppercase, digit, special char
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "weak"
}

> {%
    client.test("Weak password should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });

    client.test("Response should contain password validation error", function() {
        client.assert(response.body.data.newPassword !== undefined, "Password validation error not found");
    });
%}

###

### 12. Reset Password Missing Uppercase - Failure (400 BAD_REQUEST)
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "newsecure123!"
}

> {%
    client.test("Password without uppercase should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });
%}

###

### 13. Reset Password Missing Lowercase - Failure (400 BAD_REQUEST)
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "NEWSECURE123!"
}

> {%
    client.test("Password without lowercase should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });
%}

###

### 14. Reset Password Missing Digit - Failure (400 BAD_REQUEST)
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "NewSecure!"
}

> {%
    client.test("Password without digit should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });
%}

###

### 15. Reset Password Missing Special Character - Failure (400 BAD_REQUEST)
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "NewSecure123"
}

> {%
    client.test("Password without special char should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });
%}

###

### 16. Reset Password with Blank Password - Failure (400 BAD_REQUEST)
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": ""
}

> {%
    client.test("Blank password should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });
%}

###

### 17. Reset Password with Null Password - Failure (400 BAD_REQUEST)
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": null
}

> {%
    client.test("Null password should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });
%}

###

### 18. Reset Password with Null Token - Failure (400 BAD_REQUEST)
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": null,
  "newPassword": "NewSecure123!"
}

> {%
    client.test("Null token should return 400", function() {
        client.assert(response.status === 400, "Response status is not 400");
    });
%}

###

### ============================================
### COMPLETE PASSWORD RESET FLOW
### ============================================

### 19. Full Flow: Request → Get Token → Reset → Login
# This demonstrates a complete password reset workflow
# Run these requests in sequence

### Step 1: Request password reset
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": "flowtest@example.com"
}

> {%
    client.test("Step 1: Request should succeed", function() {
        client.assert(response.status === 200, "Request failed");
    });
    client.log("Step 1 Complete: Password reset email sent");
    client.log("Step 2: Check email inbox or database for reset token");
%}

###

### Step 2: Get reset token from email or database
# Manual step:
# - Check email inbox for password reset link
# - Extract token from URL: /reset-password?token=YOUR_TOKEN_HERE
# - OR query database: SELECT token FROM t_password_reset_token WHERE user_id = ...
# - Save token to {{resetToken}} variable

###

### Step 3: Reset password using token
POST {{baseUrl}}/auth/password-reset/reset
Content-Type: application/json

{
  "token": "{{resetToken}}",
  "newPassword": "NewFlow123!"
}

> {%
    client.test("Step 3: Password reset should succeed", function() {
        if (response.status === 400) {
            client.log("Reset failed: Check if token is valid and not expired");
            return;
        }
        client.assert(response.status === 200, "Password reset failed");
    });

    if (response.status === 200) {
        client.log("Step 3 Complete: Password reset successful");
        client.log("Step 4: Try logging in with new password");
    }
%}

###

### Step 4: Login with new password
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "username": "flowtest",
  "password": "NewFlow123!"
}

> {%
    client.test("Step 4: Login with new password should succeed", function() {
        if (response.status === 401) {
            client.log("Login failed: User might not be email verified");
            return;
        }
        client.assert(response.status === 200, "Login failed");
    });

    if (response.status === 200) {
        client.log("Step 4 Complete: Login successful with new password");
        client.log("=======================================");
        client.log("Full password reset flow completed!");
        client.log("=======================================");
    }
%}

###

### ============================================
### SECURITY TESTS
### ============================================

### 20. SQL Injection Attempt in Email - Should be Prevented
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": "admin@example.com' OR '1'='1"
}

> {%
    client.test("SQL injection attempt should be prevented", function() {
        // Should either fail validation (400) or return generic success (200)
        client.assert(response.status === 400 || response.status === 200, "Unexpected response");
    });
    client.log("Security test: SQL injection attempt handled");
%}

###

### 21. XSS Attempt in Email - Should be Sanitized
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": "<script>alert('XSS')</script>@example.com"
}

> {%
    client.test("XSS in email should fail validation", function() {
        client.assert(response.status === 400, "Should return 400 for invalid email format");
    });
    client.log("Security test: XSS attempt rejected by validation");
%}

###

### 22. Very Long Email - Should Be Rejected
POST {{baseUrl}}/auth/password-reset/request
Content-Type: application/json

{
  "email": "${'a'.repeat(300)}@example.com"
}

> {%
    client.test("Very long email should be rejected", function() {
        client.assert(response.status === 400, "Should return 400 for validation failure");
    });
%}

###

### ============================================
### NOTES
### ============================================
#
# How to get reset token for testing:
#
# Method 1: From email (if email is configured)
# - Check email inbox after requesting password reset
# - Extract token from URL: http://localhost:3000/reset-password?token=YOUR_TOKEN
#
# Method 2: From database
# - Run SQL query:
#   SELECT token FROM t_password_reset_token
#   WHERE user_id = (SELECT id FROM t_user WHERE email = 'test@example.com')
#   ORDER BY created_at DESC LIMIT 1;
#
# Method 3: From application logs (if logging is enabled)
# - Check console output for password reset link
#
# Then save the token:
# - In IntelliJ HTTP Client: Right-click response → "Add to Environment Variables"
# - Or manually set in http-client.env.json:
#   {
#     "dev": {
#       "resetToken": "YOUR_TOKEN_HERE"
#     }
#   }
#
###
